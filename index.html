<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Santri Pro - Sistem Manajemen Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .nav-active { background-color: #f0fdf4; color: #059669; border-right: 4px solid #059669; }
        .sidebar-minimized { width: 80px !important; }
        .sidebar-minimized .logo-text, .sidebar-minimized span { display: none; }
        .sidebar-minimized .nav-btn { justify-content: center; }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .status-pending { background-color: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; }
        .status-synced { background-color: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md space-y-8 text-center">
            <div id="login-logo" class="w-20 h-20 bg-green-600 rounded-2xl flex items-center justify-center text-white mx-auto shadow-xl shadow-green-100">
                <i class="fas fa-mosque fa-3x"></i>
            </div>
            <h1 class="text-3xl font-bold" id="login-pondok-name">E-Santri</h1>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-2">Username</label>
                    <input type="text" id="login-user" placeholder="admin" class="w-full px-6 py-4 border rounded-2xl text-lg outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-2">Password</label>
                    <input type="password" id="login-pass" placeholder="••••••••" class="w-full px-6 py-4 border rounded-2xl text-lg outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button onclick="handleLogin()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold text-xl hover:bg-green-700 shadow-xl shadow-green-100 transition-all">Masuk</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="flex h-screen overflow-hidden hidden">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 z-30">
            <div class="p-6 flex items-center gap-3 shrink-0">
                <div id="sidebar-logo" class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center text-white shrink-0">
                    <i class="fas fa-mosque"></i>
                </div>
                <span class="font-bold text-xl logo-text truncate" id="display-pondok">E-Santri</span>
            </div>

            <nav id="sidebar-nav" class="flex-1 px-4 space-y-1 overflow-y-auto">
                <!-- Nav items generated by JS based on roles -->
            </nav>

            <div class="p-4 border-t border-gray-100 space-y-2">
                <button id="btn-sync" onclick="manualSync()" class="w-full flex items-center justify-center gap-2 py-2 text-xs font-bold text-blue-600 hover:bg-blue-50 rounded-lg">
                    <i class="fas fa-sync-alt"></i> <span id="sync-text">Sync Manual</span>
                </button>
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-2 text-xs font-bold text-red-600 hover:bg-red-50 rounded-lg">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0">
                <div class="flex items-center gap-4">
                    <button id="toggle-sidebar" class="text-gray-400 hover:text-green-600"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="text-lg font-bold">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="online-status" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <div class="text-right hidden md:block">
                        <p id="user-display-name" class="text-sm font-bold">User</p>
                        <p id="user-display-role" class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Role</p>
                    </div>
                </div>
            </header>

            <div id="main-scroll" class="flex-1 overflow-y-auto p-4 md:p-8">
                
                <!-- PAGE: DASHBOARD -->
                <div id="page-dashboard" class="page-view space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-xs font-bold uppercase">Santri Aktif</p>
                            <h3 id="dash-total-santri" class="text-3xl font-bold mt-1">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-xs font-bold uppercase">Hadir Hari Ini</p>
                            <h3 id="dash-hadir" class="text-3xl font-bold mt-1 text-green-600">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-xs font-bold uppercase">Sedang Izin</p>
                            <h3 id="dash-izin" class="text-3xl font-bold mt-1 text-orange-500">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <p class="text-gray-500 text-xs font-bold uppercase">Terlambat</p>
                            <h3 id="dash-late" class="text-3xl font-bold mt-1 text-red-500">0</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h4 class="font-bold mb-4">Statistik Gender</h4>
                            <div class="h-64"><canvas id="chart-gender"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                            <h4 class="font-bold mb-4">Aktivitas Terakhir</h4>
                            <div id="dash-recent-log" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

    <!-- PAGE: DATA SANTRI -->
    <div id="page-santri" class="page-view space-y-4 max-w-7xl mx-auto">
        <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
            <div class="flex flex-wrap gap-2">
                <button onclick="openModal('modal-santri')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-green-700 action-admin transition-all items-center">
                    <i class="fas fa-plus mr-2"></i> Tambah Santri
                </button>
                <button onclick="document.getElementById('import-file').click()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 action-admin transition-all items-center">
                    <i class="fas fa-file-import mr-2"></i> Import CSV
                </button>
                <input type="file" id="import-file" class="hidden" accept=".csv" onchange="importCSV(this)">
                <button onclick="exportData('all')" class="bg-gray-50 text-gray-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-100 transition-all items-center">
                    <i class="fas fa-file-export mr-2"></i> Export Semua
                </button>
            </div>
            
            <div id="bulk-actions" class="hidden flex items-center gap-2 bg-orange-50 p-2 rounded-xl border border-orange-100">
                <span id="bulk-count" class="text-xs font-bold text-orange-700 px-2">0 Dipilih</span>
                <select id="bulk-select" onchange="handleBulkAction(this.value)" class="text-xs border-none bg-transparent font-bold text-orange-800 outline-none cursor-pointer">
                    <option value="">-- Aksi Massal --</option>
                    <option value="export">Export Filtered</option>
                    <option value="naik">Naik Kelas</option>
                    <option value="khidmah">Set Khidmah</option>
                    <option value="alumni" class="action-admin">Set Alumni</option>
                </select>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm grid grid-cols-2 md:grid-cols-5 gap-4">
            <input type="text" id="f-search" onkeyup="renderTableSantri()" placeholder="Cari Nama/ID..." class="px-4 py-2 border rounded-xl text-sm outline-none col-span-2 md:col-span-1 focus:border-green-500">
            <select id="f-asrama" onchange="renderTableSantri()" class="px-4 py-2 border rounded-xl text-sm outline-none focus:border-green-500">
                <option value="">Semua Asrama</option>
                <option value="Sunan Ampel">Sunan Ampel</option>
                <option value="Sunan Giri">Sunan Giri</option>
                <option value="Siti Khadijah">Siti Khadijah</option>
                <option value="Siti Aisyah">Siti Aisyah</option>
            </select>
            <select id="f-sekolah" onchange="renderTableSantri()" class="px-4 py-2 border rounded-xl text-sm outline-none focus:border-green-500">
                <option value="">Semua Sekolah</option>
                <option value="MI">MI</option>
                <option value="MTs">MTs</option>
                <option value="MA">MA</option>
            </select>
            <select id="f-kelas" onchange="renderTableSantri()" class="px-4 py-2 border rounded-xl text-sm outline-none focus:border-green-500">
                <option value="">Semua Kelas</option>
                <option value="7">Kelas 7</option>
                <option value="8">Kelas 8</option>
                <option value="9">Kelas 9</option>
                <option value="10">Kelas 10</option>
                <option value="11">Kelas 11</option>
                <option value="12">Kelas 12</option>
            </select>
            <select id="f-gender" onchange="renderTableSantri()" class="px-4 py-2 border rounded-xl text-sm outline-none focus:border-green-500">
                <option value="">Semua Gender</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
            </select>
        </div>

        <!-- TABLE -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                    <tr>
                        <th class="px-6 py-4 w-10"><input type="checkbox" id="check-all" onclick="toggleCheckAll(this)" class="rounded text-green-600 focus:ring-green-500"></th>
                        <th class="px-6 py-4">ID</th>
                        <th class="px-6 py-4">Nama Santri</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Asrama</th>
                        <th class="px-6 py-4">Kelas</th>
                        <th class="px-6 py-4 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-santri-body" class="divide-y divide-gray-100 text-sm font-medium">
                    <!-- Data will be injected here -->
                </tbody>
            </table>
            <div id="empty-state" class="hidden py-20 text-center">
                <i class="fas fa-user-slash text-4xl text-gray-200 mb-4"></i>
                <p class="text-gray-400">Data santri tidak ditemukan</p>
            </div>
        </div>
    </div>

    <!-- PAGE: PERIZINAN -->
    <div id="page-perizinan" class="page-view space-y-6 max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                <div>
                    <h3 class="font-bold text-xl">Logistik Keamanan</h3>
                    <p class="text-sm text-gray-500">Kelola izin keluar atau catat kepulangan santri.</p>
                </div>
                <div class="flex p-1 bg-gray-100 rounded-xl self-start overflow-x-auto max-w-full">
                    <button onclick="toggleIzinMode('biasa')" id="tab-izin-biasa" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-green-600 transition-all">Izin Biasa</button>
                    <button onclick="toggleIzinMode('libur')" id="tab-izin-libur" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all">Libur Panjang</button>
                    <button onclick="toggleIzinMode('checkin')" id="tab-izin-checkin" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all">Check In</button>
                </div>
            </div>

            <!-- SCANNER SECTION -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div id="qr-reader" class="w-full rounded-2xl overflow-hidden bg-black aspect-video flex items-center justify-center text-gray-600 relative">
                        <i class="fas fa-camera text-3xl"></i>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="startScanner()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-100 hover:bg-green-700 transition-all" id="btn-scan-main">Mulai Scan</button>
                        <button onclick="stopScanner()" class="px-4 border rounded-xl text-gray-400 hover:text-red-500 transition-all"><i class="fas fa-power-off"></i></button>
                    </div>

                    <div id="izin-form-inputs" class="bg-gray-50 p-4 rounded-2xl space-y-3 border border-gray-100">
                        <!-- Fields Izin Biasa -->
                        <div id="fields-biasa" class="grid grid-cols-2 gap-3">
                            <div class="col-span-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Alasan Keluar</label>
                                <input type="text" id="biasa-alasan" placeholder="Contoh: Beli kitab, berobat..." class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="col-span-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Batas Kembali</label>
                                <input type="datetime-local" id="biasa-deadline" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>

                        <!-- Fields Libur Panjang -->
                        <div id="fields-libur" class="hidden grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Mulai Libur</label>
                                <input type="date" id="libur-start" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Selesai Libur</label>
                                <input type="date" id="libur-end" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Fields Check In -->
                        <div id="fields-checkin" class="hidden">
                            <div class="bg-purple-50 p-3 rounded-xl border border-purple-100">
                                <p class="text-[10px] font-bold text-purple-700 uppercase mb-1 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i> Mode Check In Otomatis
                                </p>
                                <p class="text-[11px] text-purple-600 leading-tight">Status santri akan otomatis diperbarui menjadi "Kembali" saat ID diproses.</p>
                            </div>
                        </div>

                        <div class="relative pt-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">ID Santri</label>
                            <div class="flex gap-2">
                                <input type="text" id="manual-nis" placeholder="Scan atau Ketik ID..." class="flex-1 px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-green-500 transition-all font-mono" onkeypress="if(event.key === 'Enter') processIzin(this.value)">
                                <button id="btn-proses-manual" onclick="processIzin(document.getElementById('manual-nis').value)" class="bg-gray-800 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-black transition-all">Proses</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div id="izin-mode-indicator" class="p-4 bg-green-50 border border-green-100 rounded-2xl transition-all">
                        <h4 class="font-bold text-green-800" id="mode-title">Mode: Izin Keluar Biasa</h4>
                        <p class="text-xs text-green-600" id="mode-desc">Santri keluar untuk keperluan jangka pendek (belanja, berobat, dll).</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4 min-h-[300px] border border-gray-100 flex flex-col">
                        <h5 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Log Aktivitas Terbaru</h5>
                        <div id="izin-status-log" class="space-y-2 flex-1 overflow-y-auto">
                            <p id="log-placeholder" class="text-center text-gray-300 py-20 text-xs italic">Belum ada aktivitas scan</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                <!-- PAGE: PENGATURAN -->
                <div id="page-pengaturan" class="page-view hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                            <h3 class="font-bold border-b pb-2">Identitas Pesantren</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-400">Nama Pesantren</label>
                                    <input type="text" id="set-pondok-name" class="w-full px-4 py-2 border rounded-xl mt-1 outline-none">
                                </div>
                                <button onclick="saveSettings()" class="w-full bg-green-600 text-white py-2 rounded-xl font-bold">Simpan Perubahan</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                            <h3 class="font-bold border-b pb-2">Daftar Asrama</h3>
                            <div class="flex gap-2">
                                <input type="text" id="new-asrama" placeholder="Nama Asrama Baru..." class="flex-1 px-4 py-2 border rounded-xl outline-none text-sm">
                                <button onclick="addAsrama()" class="bg-gray-800 text-white px-4 py-2 rounded-xl"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="asrama-list-ui" class="space-y-2 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL SANTRI -->
    <div id="modal-santri" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl scale-in">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="font-bold text-xl">Tambah Santri Baru</h3>
                <button onclick="closeModal('modal-santri')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Field Wajib</label>
                    <div class="space-y-3 mt-2">
                        <input type="text" id="s-nama" placeholder="Nama Lengkap Santri" class="w-full px-4 py-2 border rounded-xl outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <select id="s-gender" class="px-4 py-2 border rounded-xl"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select>
                            <select id="s-asrama" class="px-4 py-2 border rounded-xl"></select>
                            <select id="s-sekolah" onchange="updateKelasSelect('s-kelas', this.value)" class="px-4 py-2 border rounded-xl">
                                <option value="MI">MI</option><option value="MTs">MTs</option><option value="MA">MA</option>
                            </select>
                            <select id="s-kelas" class="px-4 py-2 border rounded-xl"></select>
                        </div>
                    </div>
                </div>
                <div class="pt-4 border-t">
                    <label class="text-xs font-bold text-gray-400 uppercase">Field Opsional</label>
                    <div class="space-y-3 mt-2">
                        <input type="text" id="s-wali" placeholder="Nama Wali" class="w-full px-4 py-2 border rounded-xl outline-none">
                        <input type="text" id="s-alamat" placeholder="Alamat Lengkap" class="w-full px-4 py-2 border rounded-xl outline-none">
                        <input type="text" id="s-telp" placeholder="Nomor Telepon Wali" class="w-full px-4 py-2 border rounded-xl outline-none">
                    </div>
                </div>
            </div>
            <div class="p-6 bg-gray-50 flex gap-3">
                <button onclick="closeModal('modal-santri')" class="flex-1 py-3 font-bold text-gray-500">Batal</button>
                <button onclick="saveSantri()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Simpan Data</button>
            </div>
        </div>
    </div>

    <!-- REASON MODAL -->
    <div id="modal-reason" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-in">
            <h3 class="font-bold text-lg mb-4">Alasan Izin</h3>
            <div class="space-y-4">
                <input type="text" id="izin-reason" placeholder="Misal: Berobat, Belanja..." class="w-full px-4 py-3 border rounded-xl outline-none">
                <div class="flex gap-2">
                    <button onclick="closeModal('modal-reason')" class="flex-1 py-3 font-bold text-gray-400">Batal</button>
                    <button id="confirm-izin-btn" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Keluarkan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const DB_KEY = "esantri_db_v3";
        let db = {
            santri: [],
            alumni: [],
            izin: [],
            users: [
                { id: 1, user: 'admin', pass: 'admin123', role: 'Admin', status: 'Aktif' },
                { id: 2, user: 'guru', pass: 'guru123', role: 'Guru', status: 'Aktif' },
                { id: 3, user: 'pengurus', pass: 'pengurus123', role: 'Pengurus', status: 'Aktif' }
            ],
            settings: {
                pondok: "E-Santri Indonesia",
                asrama: ["Asrama Utara", "Asrama Selatan"],
                izinMode: "biasa" // biasa / libur
            },
            pendingSync: []
        };

        let currentUser = null;
        let selectedIds = new Set();
        let html5QrCode = null;

        // --- CORE LOGIC ---
        window.onload = function() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) db = JSON.parse(saved);
            
            checkSession();
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        };

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        function updateOnlineStatus() {
            const ind = document.getElementById('online-status');
            if(!ind) return;
            ind.className = navigator.onLine ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-red-500";
            if(navigator.onLine && db.pendingSync.length > 0) manualSync();
        }

        function checkSession() {
            const session = sessionStorage.getItem('esantri_session');
            if(session) {
                currentUser = JSON.parse(session);
                loadApp();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        }

        function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const user = db.users.find(x => x.user === u && x.pass === p);
            
            if(user) {
                if(user.status !== 'Aktif') return alert("Akun Anda dinonaktifkan!");
                sessionStorage.setItem('esantri_session', JSON.stringify(user));
                currentUser = user;
                loadApp();
            } else {
                alert("Login gagal! Periksa kembali username & password.");
            }
        }

        function loadApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.user;
            document.getElementById('user-display-role').innerText = currentUser.role;
            document.getElementById('display-pondok').innerText = db.settings.pondok;
            document.getElementById('login-pondok-name').innerText = db.settings.pondok;

            renderSidebar();
            initFilters();
            renderStats();
            renderAsramaList();
            showPage('dashboard');
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { id: 'dashboard', icon: 'fa-th-large', label: 'Dashboard', roles: ['Admin', 'Guru', 'Pengurus'] },
                { id: 'santri', icon: 'fa-user-graduate', label: 'Data Santri', roles: ['Admin', 'Guru'] },
                { id: 'perizinan', icon: 'fa-id-badge', label: 'Perizinan', roles: ['Admin', 'Pengurus'] },
                { id: 'pengaturan', icon: 'fa-cog', label: 'Pengaturan', roles: ['Admin'] }
            ];

            nav.innerHTML = items.filter(i => i.roles.includes(currentUser.role)).map(i => `
                <button onclick="showPage('${i.id}')" id="nav-${i.id}" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                    <i class="fas ${i.icon} w-5"></i> <span>${i.label}</span>
                </button>
            `).join('');
        }

        function showPage(id) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            const btn = document.getElementById('nav-' + id);
            if(btn) btn.classList.add('nav-active');

            document.getElementById('page-title').innerText = id === 'dashboard' ? 'Dashboard' : id.charAt(0).toUpperCase() + id.slice(1);
            
            if(id === 'santri') renderTableSantri();
            if(id === 'pengaturan') {
                document.getElementById('set-pondok-name').value = db.settings.pondok;
                renderAsramaList();
            }
            if(id === 'perizinan') renderIzinLog();
            
            if(html5QrCode && id !== 'perizinan') stopScanner();
        }

        // --- SANTRI LOGIC ---
        function generateAutoId() {
            const ids = db.santri.map(s => parseInt(s.id));
            const max = ids.length > 0 ? Math.max(...ids) : 999;
            return max + 1;
        }

        function saveSantri() {
            const nama = document.getElementById('s-nama').value;
            const gender = document.getElementById('s-gender').value;
            const asrama = document.getElementById('s-asrama').value;
            const sekolah = document.getElementById('s-sekolah').value;
            const kelas = document.getElementById('s-kelas').value;

            if(!nama || !asrama || !sekolah || !kelas) return alert("Mohon isi semua field wajib!");

            const newSantri = {
                id: generateAutoId(),
                nama, gender, asrama, sekolah, kelas,
                wali: document.getElementById('s-wali').value || "-",
                alamat: document.getElementById('s-alamat').value || "-",
                telp: document.getElementById('s-telp').value || "-",
                status: 'Santri',
                createdAt: new Date().toISOString(),
                sync: navigator.onLine ? 'Synced' : 'Pending'
            };

            db.santri.push(newSantri);
            if(!navigator.onLine) db.pendingSync.push({ action: 'CREATE', data: newSantri });
            
            saveDB();
            closeModal('modal-santri');
            renderTableSantri();
            renderStats();
            alert("Santri berhasil ditambahkan dengan ID: " + newSantri.id);
        }

        function renderTableSantri() {
            const tbody = document.getElementById('table-santri-body');
            const s = document.getElementById('f-search').value.toLowerCase();
            const a = document.getElementById('f-asrama').value;
            const sk = document.getElementById('f-sekolah').value;
            const kl = document.getElementById('f-kelas').value;
            const gn = document.getElementById('f-gender').value;

            const filtered = db.santri.filter(x => 
                (x.nama.toLowerCase().includes(s) || x.id.toString().includes(s)) &&
                (a === "" || x.asrama === a) &&
                (sk === "" || x.sekolah === sk) &&
                (kl === "" || x.kelas === kl) &&
                (gn === "" || x.gender === gn)
            );

            tbody.innerHTML = filtered.map(x => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4"><input type="checkbox" value="${x.id}" class="row-check" onchange="updateSelected(this)"></td>
                    <td class="px-6 py-4 font-mono text-xs">${x.id}</td>
                    <td class="px-6 py-4">
                        <div>${x.nama}</div>
                        <div class="text-[10px] text-gray-400">${x.gender}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-[10px] font-bold px-2 py-1 rounded-full ${x.status === 'Santri' ? 'bg-blue-50 text-blue-600' : 'bg-purple-50 text-purple-600'}">
                            ${x.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs">${x.asrama}</td>
                    <td class="px-6 py-4 text-xs">${x.sekolah} - Kelas ${x.kelas}</td>
                    <td class="px-6 py-4 text-right">
                        ${x.sync === 'Pending' ? '<span class="status-pending mr-2">PENDING</span>' : ''}
                        <button onclick="deleteSantri(${x.id})" class="text-red-400 action-admin"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            if(currentUser.role !== 'Admin') document.querySelectorAll('.action-admin').forEach(el => el.classList.add('hidden'));
        }

        function deleteSantri(id) {
            if(!confirm("Hapus data santri ini?")) return;
            db.santri = db.santri.filter(x => x.id != id);
            saveDB(); renderTableSantri(); renderStats();
        }

        // --- BULK ACTION LOGIC ---
        function handleBulkAction(val) {
            if(!val || selectedIds.size === 0) return;
            
            if(val === 'naik') {
                if(!confirm(`Naikkan kelas untuk ${selectedIds.size} santri?`)) return;
                db.santri.forEach(s => {
                    if(selectedIds.has(s.id.toString())) {
                        processNaikKelas(s);
                    }
                });
            } else if(val === 'alumni') {
                if(!confirm(`Set ${selectedIds.size} santri sebagai Alumni?`)) return;
                const now = new Date().toLocaleDateString('id-ID');
                db.santri = db.santri.filter(s => {
                    if(selectedIds.has(s.id.toString())) {
                        db.alumni.push({ ...s, tanggalAlumni: now });
                        return false;
                    }
                    return true;
                });
            } else if(val === 'khidmah') {
                db.santri.forEach(s => { if(selectedIds.has(s.id.toString())) s.status = 'Khidmah'; });
            } else if(val === 'export') {
                exportData('filtered');
            }

            saveDB();
            selectedIds.clear();
            updateBulkUI();
            renderTableSantri();
            renderStats();
            document.getElementById('bulk-select').value = "";
        }

        function processNaikKelas(s) {
            const k = parseInt(s.kelas);
            if(s.sekolah === 'MI') {
                if(k < 6) s.kelas = (k + 1).toString();
                else { s.sekolah = 'MTs'; s.kelas = '1'; }
            } else if(s.sekolah === 'MTs') {
                if(k < 3) s.kelas = (k + 1).toString();
                else { s.sekolah = 'MA'; s.kelas = '1'; }
            } else if(s.sekolah === 'MA') {
                if(k < 3) s.kelas = (k + 1).toString();
                else { s.status = 'Khidmah'; }
            }
        }

        // --- PERIZINAN SCANNER ---
        function toggleIzinMode(mode) {
            db.settings.izinMode = mode;
            const bBtn = document.getElementById('tab-izin-biasa');
            const lBtn = document.getElementById('tab-izin-libur');
            const mTitle = document.getElementById('mode-title');
            const mDesc = document.getElementById('mode-desc');
            const mInd = document.getElementById('izin-mode-indicator');

            if(mode === 'biasa') {
                bBtn.className = "px-6 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-green-600";
                lBtn.className = "px-6 py-2 rounded-lg text-sm font-bold text-gray-500";
                mTitle.innerText = "Mode: Izin Keluar Biasa";
                mDesc.innerText = "Santri keluar untuk keperluan jangka pendek (belanja, berobat, dll).";
                mInd.className = "p-4 bg-green-50 border border-green-100 rounded-2xl";
            } else {
                lBtn.className = "px-6 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-blue-600";
                bBtn.className = "px-6 py-2 rounded-lg text-sm font-bold text-gray-500";
                mTitle.innerText = "Mode: Libur Panjang";
                mDesc.innerText = "Mode khusus kepulangan santri secara serentak (Libur Semester/Hari Raya).";
                mInd.className = "p-4 bg-blue-50 border border-blue-100 rounded-2xl";
            }
            saveDB();
        }

        function startScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                processIzin(text);
            }).catch(err => alert("Kamera Error: " + err));
        }

        function stopScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => html5QrCode = null);
            }
        }

        function processIzin(id) {
            const santri = db.santri.find(s => s.id == id);
            if(!santri) return alert("Santri dengan ID " + id + " tidak ditemukan!");

            if(db.settings.izinMode === 'libur') {
                submitIzin(santri, "Libur Panjang", null);
            } else {
                const existing = db.izin.find(i => i.santriId == id && !i.kembaliAt);
                if(existing) {
                    // Check-in
                    existing.kembaliAt = new Date().toLocaleString('id-ID');
                    alert(`Check-in: ${santri.nama} telah kembali.`);
                    saveDB();
                    renderIzinLog();
                    renderStats();
                } else {
                    // Check-out (Buka Modal Alasan)
                    document.getElementById('modal-reason').classList.remove('hidden');
                    document.getElementById('izin-reason').value = "";
                    document.getElementById('confirm-izin-btn').onclick = () => {
                        const alasan = document.getElementById('izin-reason').value || "Keperluan Santri";
                        submitIzin(santri, alasan, "2 Jam");
                        closeModal('modal-reason');
                    };
                }
            }
        }

        function submitIzin(s, alasan, durasi) {
            const entry = {
                id: Date.now(),
                santriId: s.id,
                nama: s.nama,
                alasan: alasan,
                waktu: new Date().toLocaleString('id-ID'),
                kembaliAt: null,
                tipe: db.settings.izinMode
            };
            db.izin.push(entry);
            saveDB();
            renderIzinLog();
            renderStats();
            alert(`${s.nama} tercatat ${alasan}`);
        }

        function renderIzinLog() {
            const log = document.getElementById('izin-status-log');
            if(!log) return;
            log.innerHTML = db.izin.slice(-20).reverse().map(i => `
                <div class="p-3 bg-white border rounded-xl text-xs flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold">${i.nama} <span class="text-[10px] text-gray-400 font-normal">#${i.santriId}</span></div>
                        <div class="text-gray-500">${i.alasan} • ${i.waktu}</div>
                    </div>
                    <div class="${i.kembaliAt ? 'text-green-600' : 'text-orange-500'} font-bold">
                        ${i.kembaliAt ? 'KEMBALI' : 'DI LUAR'}
                    </div>
                </div>
            `).join('');
        }

        // --- DASHBOARD RECOVERY ---
        function renderStats() {
            const total = db.santri.length;
            const hadir = total - db.izin.filter(i => !i.kembaliAt).length;
            const izin = db.izin.filter(i => !i.kembaliAt).length;
            
            if(document.getElementById('dash-total-santri')) document.getElementById('dash-total-santri').innerText = total;
            if(document.getElementById('dash-hadir')) document.getElementById('dash-hadir').innerText = hadir;
            if(document.getElementById('dash-izin')) document.getElementById('dash-izin').innerText = izin;
            
            renderCharts();
            renderRecentLogs();
        }

        function renderRecentLogs() {
            const log = document.getElementById('dash-recent-log');
            if(!log) return;
            log.innerHTML = db.izin.slice(-5).reverse().map(i => `
                <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                    <div class="w-2 h-2 rounded-full ${i.kembaliAt ? 'bg-green-500' : 'bg-orange-500'}"></div>
                    <div class="flex-1">
                        <p class="text-xs font-bold">${i.nama}</p>
                        <p class="text-[10px] text-gray-400">${i.alasan} - ${i.waktu}</p>
                    </div>
                </div>
            `).join('') || '<p class="text-xs text-gray-400 text-center py-4">Belum ada aktivitas.</p>';
        }

        function renderCharts() {
            const ctx = document.getElementById('chart-gender')?.getContext('2d');
            if(!ctx) return;
            if(window.myChart) window.myChart.destroy();
            
            const l = db.santri.filter(s => s.gender === 'Laki-laki').length;
            const p = db.santri.filter(s => s.gender === 'Perempuan').length;

            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Laki-laki', 'Perempuan'],
                    datasets: [{
                        data: [l, p],
                        backgroundColor: ['#3b82f6', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- EXPORT / IMPORT ---
        function exportData(type) {
            let data = db.santri;
            if(type === 'filtered') {
                const s = document.getElementById('f-search').value.toLowerCase();
                const a = document.getElementById('f-asrama').value;
                data = db.santri.filter(x => 
                    (x.nama.toLowerCase().includes(s) || x.id.toString().includes(s)) &&
                    (a === "" || x.asrama === a)
                );
            }

            let csv = "ID;Nama;Gender;Asrama;Sekolah;Kelas;Wali;Alamat;Telepon\n";
            data.forEach(x => {
                csv += `${x.id};${x.nama};${x.gender};${x.asrama};${x.sekolah};${x.kelas};${x.wali};${x.alamat};${x.telp}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `data_santri_${new Date().getTime()}.csv`);
            a.click();
        }

        function importCSV(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                let count = 0;
                for(let i = 1; i < lines.length; i++) {
                    const col = lines[i].split(';');
                    if(col.length < 5) continue;
                    db.santri.push({
                        id: generateAutoId(),
                        nama: col[1], gender: col[2], asrama: col[3], sekolah: col[4], kelas: col[5],
                        wali: col[6] || "-", alamat: col[7] || "-", telp: col[8] || "-",
                        status: 'Santri', createdAt: new Date().toISOString(), sync: 'Pending'
                    });
                    count++;
                }
                saveDB(); renderTableSantri(); renderStats();
                alert(`Berhasil mengimport ${count} santri baru.`);
            };
            reader.readAsText(file);
        }

        // --- UI UTILS ---
        function initFilters() {
            updateAsramaSelects();
            updateKelasSelect('s-kelas', 'MI');
            updateKelasSelect('f-kelas', 'MI'); // Default initial
        }

        function updateAsramaSelects() {
            const opts = db.settings.asrama.map(a => `<option value="${a}">${a}</option>`).join('');
            document.getElementById('s-asrama').innerHTML = opts;
            document.getElementById('f-asrama').innerHTML = '<option value="">Semua Asrama</option>' + opts;
        }

        function updateKelasSelect(targetId, sekolah) {
            const target = document.getElementById(targetId);
            let limit = sekolah === 'MI' ? 6 : 3;
            let html = targetId.startsWith('f') ? '<option value="">Semua Kelas</option>' : '';
            for(let i=1; i<=limit; i++) html += `<option value="${i}">${i}</option>`;
            target.innerHTML = html;
        }

        function updateSelected(el) {
            el.checked ? selectedIds.add(el.value) : selectedIds.delete(el.value);
            updateBulkUI();
        }

        function toggleCheckAll(src) {
            document.querySelectorAll('.row-check').forEach(c => {
                c.checked = src.checked;
                updateSelected(c);
            });
        }

        function updateBulkUI() {
            const bar = document.getElementById('bulk-actions');
            bar.classList.toggle('hidden', selectedIds.size === 0);
            document.getElementById('bulk-count').innerText = `${selectedIds.size} Dipilih`;
        }

        function addAsrama() {
            const val = document.getElementById('new-asrama').value;
            if(!val) return;
            db.settings.asrama.push(val);
            saveDB(); renderAsramaList(); updateAsramaSelects();
            document.getElementById('new-asrama').value = "";
        }

        function renderAsramaList() {
            const ui = document.getElementById('asrama-list-ui');
            if(!ui) return;
            ui.innerHTML = db.settings.asrama.map(a => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl text-sm">
                    <span>${a}</span>
                    <button onclick="deleteAsrama('${a}')" class="text-red-400"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function deleteAsrama(a) {
            db.settings.asrama = db.settings.asrama.filter(x => x !== a);
            saveDB(); renderAsramaList(); updateAsramaSelects();
        }

        function manualSync() {
            if(!navigator.onLine) return alert("Offline: Hubungkan ke internet untuk sinkronisasi.");
            document.getElementById('sync-text').innerText = "Syncing...";
            setTimeout(() => {
                db.santri.forEach(s => s.sync = 'Synced');
                db.pendingSync = [];
                saveDB();
                renderTableSantri();
                document.getElementById('sync-text').innerText = "Sync Berhasil";
                setTimeout(() => document.getElementById('sync-text').innerText = "Sync Manual", 2000);
            }, 1500);
        }

        function saveSettings() {
            db.settings.pondok = document.getElementById('set-pondok-name').value;
            saveDB();
            loadApp();
            alert("Pengaturan disimpan!");
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { sessionStorage.removeItem('esantri_session'); location.reload(); }

        document.getElementById('toggle-sidebar').onclick = () => {
            document.getElementById('sidebar').classList.toggle('sidebar-minimized');
        };
    </script>
</body>
</html>



