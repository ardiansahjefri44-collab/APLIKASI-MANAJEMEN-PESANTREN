<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Santri Pro - Perizinan Smart Scan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f9fafb; }
        .nav-active { background-color: #f0fdf4; color: #059669; border-right: 4px solid #059669; }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #059669; color: white; transition: background 0.2s; }
        .btn-primary:hover { background-color: #047857; }
        #reader-global { border: none !important; width: 100% !important; }
    </style>
</head>
<body class="h-screen flex text-slate-800">

    <!-- Login Page -->
    <div id="login-page" class="fixed inset-0 z-[100] flex items-center justify-center bg-emerald-600 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md scale-in text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full mb-4">
                <i class="fas fa-mosque fa-2x"></i>
            </div>
            <h1 class="text-2xl font-bold">E-Santri Pro</h1>
            <p class="text-slate-500 mb-6">Pondok Pesantren Madani</p>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Username" required>
                <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Password" required>
                <button type="submit" class="w-full py-3 btn-primary rounded-lg font-semibold shadow-lg">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r h-full flex flex-col transition-all duration-300 z-50">
        <div class="p-6 flex items-center gap-3 border-b h-20">
            <div class="w-10 h-10 bg-emerald-600 flex items-center justify-center rounded-lg text-white">
                <i class="fas fa-quran text-xl"></i>
            </div>
            <span class="font-bold text-xl tracking-tight logo-text">E-Santri<span class="text-emerald-600">Pro</span></span>
        </div>
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto scrollbar-hide">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" data-tab="dashboard">
                <i class="fas fa-home w-5"></i><span>Dashboard</span>
            </button>
            <button onclick="switchTab('santri')" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" data-tab="santri">
                <i class="fas fa-users w-5"></i><span>Data Santri</span>
            </button>
            <button onclick="switchTab('perizinan')" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" data-tab="perizinan">
                <i class="fas fa-id-card-clip w-5"></i><span>Perizinan</span>
            </button>
            <button onclick="switchTab('pelanggaran')" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" data-tab="pelanggaran">
                <i class="fas fa-exclamation-triangle w-5"></i><span>Pelanggaran</span>
            </button>
            <div id="admin-nav" class="hidden">
                <button onclick="switchTab('pengaturan')" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" data-tab="pengaturan">
                    <i class="fas fa-cog w-5"></i><span>Pengaturan</span>
                </button>
            </div>
        </nav>
        <div class="p-4 border-t">
            <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                <i class="fas fa-sign-out-alt w-5"></i><span>Keluar</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-slate-50 overflow-hidden">
        <!-- Header -->
        <header class="h-20 bg-white border-b px-8 flex items-center justify-between z-40">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-xl font-bold text-slate-800">Perizinan</h2>
            </div>
            <div class="flex items-center gap-3 text-right">
                <div>
                    <p id="user-display" class="text-sm font-bold">Admin</p>
                    <p id="pondok-display" class="text-[10px] text-emerald-600 font-bold uppercase">Pesantren Madani</p>
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 scrollbar-hide">
            
            <!-- Dashboard -->
            <section id="tab-dashboard" class="tab-content hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-2xl border">
                        <p class="text-xs font-bold text-slate-400 mb-1">TOTAL SANTRI</p>
                        <h3 class="text-2xl font-bold" id="dash-total">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border">
                        <p class="text-xs font-bold text-slate-400 mb-1">SEDANG IZIN</p>
                        <h3 class="text-2xl font-bold text-orange-500" id="dash-izin">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border">
                        <p class="text-xs font-bold text-slate-400 mb-1">TOTAL POIN</p>
                        <h3 class="text-2xl font-bold text-red-600" id="dash-poin">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border">
                        <p class="text-xs font-bold text-slate-400 mb-1">PENGGUNA</p>
                        <h3 class="text-2xl font-bold text-blue-600" id="dash-user">0</h3>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border h-96">
                    <canvas id="kamarChart"></canvas>
                </div>
            </section>

            <!-- Perizinan -->
            <section id="tab-perizinan" class="tab-content space-y-8">
                <!-- Opsi Tombol Utama -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button onclick="openIzinModal('biasa')" class="group bg-white p-6 rounded-2xl border hover:border-orange-500 hover:shadow-xl transition-all flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                            <i class="fas fa-walking"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-bold text-lg">Izin Biasa</h4>
                            <p class="text-xs text-slate-400">Scan NIS / Input Manual</p>
                        </div>
                    </button>
                    <button onclick="openIzinModal('libur')" class="group bg-white p-6 rounded-2xl border hover:border-blue-500 hover:shadow-xl transition-all flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                            <i class="fas fa-plane-departure"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-bold text-lg">Libur Panjang</h4>
                            <p class="text-xs text-slate-400">Masa Liburan Massal</p>
                        </div>
                    </button>
                    <button onclick="openIzinModal('checkin')" class="group bg-white p-6 rounded-2xl border hover:border-emerald-500 hover:shadow-xl transition-all flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-bold text-lg">Check-In</h4>
                            <p class="text-xs text-slate-400">Kembali ke Pondok</p>
                        </div>
                    </button>
                </div>

                <!-- Log Perizinan -->
                <div class="bg-white rounded-2xl border overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                        <h4 class="font-bold text-sm uppercase">Riwayat Aktivitas</h4>
                        <button onclick="exportData('izin')" class="text-xs font-bold text-emerald-600">Export CSV</button>
                    </div>
                    <div class="divide-y max-h-[400px] overflow-y-auto" id="log-izin"></div>
                </div>
            </section>

            <!-- Santri & Pelanggaran tetap ada (disingkat untuk fokus pada request) -->
            <section id="tab-santri" class="tab-content hidden space-y-4">
                <div class="flex justify-between items-center">
                    <input type="text" id="src-santri" oninput="renderSantri()" placeholder="Cari NIS/Nama..." class="px-4 py-2 border rounded-xl w-1/3">
                    <button onclick="openModal('modal-santri')" class="btn-primary px-6 py-2 rounded-xl font-bold">Tambah Santri</button>
                </div>
                <div class="bg-white rounded-2xl border overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 font-bold"><tr><th class="p-4">Santri</th><th class="p-4">NIS</th><th class="p-4">Kamar</th><th class="p-4">Status</th><th class="p-4"></th></tr></thead>
                        <tbody id="table-santri" class="divide-y"></tbody>
                    </table>
                </div>
            </section>

            <!-- Pelanggaran -->
            <section id="tab-pelanggaran" class="tab-content hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl border h-fit">
                        <h4 class="font-bold mb-4 uppercase text-xs">Input Pelanggaran</h4>
                        <form id="form-pelanggaran" class="space-y-3">
                            <select id="p-sid" class="w-full p-2 border rounded-lg text-sm" required></select>
                            <select id="p-tipe" class="w-full p-2 border rounded-lg text-sm" required>
                                <option value="Ringan">Ringan (5)</option>
                                <option value="Sedang">Sedang (25)</option>
                                <option value="Berat">Berat (100)</option>
                            </select>
                            <textarea id="p-ket" placeholder="Keterangan..." class="w-full p-2 border rounded-lg text-sm h-24"></textarea>
                            <button class="w-full py-2 bg-red-600 text-white font-bold rounded-lg">SIMPAN</button>
                        </form>
                    </div>
                    <div class="md:col-span-2 bg-white rounded-2xl border overflow-hidden">
                         <div class="p-4 border-b flex justify-between bg-slate-50">
                            <h4 class="font-bold text-xs uppercase">Daftar Pelanggaran</h4>
                            <button onclick="exportData('pelanggaran')" class="text-xs text-red-600 font-bold">Export</button>
                         </div>
                         <table class="w-full text-left text-sm">
                             <thead class="bg-slate-50"><tr><th class="p-3">Santri</th><th class="p-3">Tipe</th><th class="p-3">Poin</th><th class="p-3">Tanggal</th></tr></thead>
                             <tbody id="table-pelanggaran" class="divide-y"></tbody>
                         </table>
                    </div>
                </div>
            </section>

            <!-- Pengaturan -->
            <section id="tab-pengaturan" class="tab-content hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl border">
                        <h4 class="font-bold mb-4 uppercase text-xs">Profil Pesantren</h4>
                        <input type="text" id="set-pondok" class="w-full p-2 border rounded-lg mb-3">
                        <button onclick="saveSettings()" class="px-6 py-2 btn-primary rounded-lg font-bold">Simpan</button>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border">
                        <h4 class="font-bold mb-4 uppercase text-xs">Manajemen User</h4>
                        <form id="form-user" class="flex gap-2 mb-4">
                            <input type="text" id="u-name" placeholder="User" class="flex-1 p-2 border rounded-lg text-sm">
                            <input type="password" id="u-pass" placeholder="Pass" class="flex-1 p-2 border rounded-lg text-sm">
                            <button class="px-4 py-2 bg-emerald-600 text-white rounded-lg"><i class="fas fa-plus"></i></button>
                        </form>
                        <div id="list-user" class="space-y-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal Smart Perizinan (Izin Biasa / Libur / Checkin) -->
    <div id="modal-smart-izin" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl scale-in">
            <div id="smart-header" class="px-6 py-4 flex justify-between items-center text-white">
                <h4 id="smart-title" class="font-bold">Form Perizinan</h4>
                <button onclick="closeSmartModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Global Scanner Area -->
                <div id="scanner-container" class="hidden space-y-3">
                    <div id="reader-global" class="rounded-2xl overflow-hidden bg-black aspect-video"></div>
                    <p class="text-[10px] text-center text-slate-400 font-bold uppercase">Arahkan Kamera ke Barcode/QR NIS Santri</p>
                </div>

                <div id="smart-form-container">
                    <!-- Dinamis Konten -->
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input type="text" id="sm-nis" placeholder="NIS Santri" class="flex-1 px-4 py-3 border rounded-xl font-bold text-emerald-700 bg-emerald-50 outline-none focus:ring-2 focus:ring-emerald-500">
                            <button onclick="toggleScanner()" class="px-4 bg-slate-800 text-white rounded-xl shadow-lg"><i class="fas fa-camera"></i></button>
                        </div>
                        <div id="sm-info" class="p-3 bg-slate-50 rounded-xl text-xs font-semibold text-slate-500 hidden"></div>
                        
                        <!-- Area Izin Biasa -->
                        <div id="area-biasa" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">TGL KELUAR</label><input type="date" id="sm-tgl-out" class="w-full p-2 border rounded-lg text-sm"></div>
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">JAM KELUAR</label><input type="time" id="sm-jam-out" class="w-full p-2 border rounded-lg text-sm"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">BATAS KEMBALI</label><input type="date" id="sm-tgl-in" class="w-full p-2 border rounded-lg text-sm"></div>
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">JAM KEMBALI</label><input type="time" id="sm-jam-in" class="w-full p-2 border rounded-lg text-sm"></div>
                            </div>
                            <textarea id="sm-alasan" placeholder="Alasan Izin..." class="w-full p-3 border rounded-xl text-sm h-20"></textarea>
                        </div>

                        <!-- Area Libur -->
                        <div id="area-libur" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">MULAI</label><input type="date" id="lib-start" class="w-full p-2 border rounded-lg text-sm"></div>
                                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400">BERAKHIR</label><input type="date" id="lib-end" class="w-full p-2 border rounded-lg text-sm"></div>
                            </div>
                            <p class="text-[10px] text-blue-500 font-bold bg-blue-50 p-2 rounded italic">Info: Status santri otomatis "Libur" tanpa notifikasi.</p>
                        </div>

                        <!-- Area Checkin -->
                        <div id="area-checkin" class="hidden text-center py-4">
                            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 animate-bounce">
                                <i class="fas fa-home"></i>
                            </div>
                            <p class="text-sm font-bold text-slate-600">Klik tombol di bawah untuk konfirmasi kembali ke pondok.</p>
                        </div>
                    </div>
                </div>
                
                <button id="sm-submit" onclick="processSmartAction()" class="w-full py-4 text-white font-black rounded-2xl shadow-xl transition-transform active:scale-95"></button>
            </div>
        </div>
    </div>

    <!-- Modal Santri -->
    <div id="modal-santri" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/50 p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-md">
            <h4 class="font-bold mb-4">Data Santri Baru</h4>
            <form id="form-santri" class="space-y-4">
                <input type="text" id="s-nama" placeholder="Nama Lengkap" class="w-full p-2 border rounded-lg" required>
                <input type="text" id="s-nis" placeholder="NIS" class="w-full p-2 border rounded-lg" required>
                <input type="text" id="s-asrama" placeholder="Asrama" class="w-full p-2 border rounded-lg" required>
                <button class="w-full py-3 btn-primary rounded-xl font-bold">SIMPAN</button>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-3 rounded-full shadow-2xl opacity-0 transition-all z-[200]"></div>

    <script>
        // Database
        let db = {
            santri: [
                { id: 1, nama: "Ahmad Junaidi", nis: "1001", asrama: "Al-Fatih", status: "Aktif", poin: 0 },
                { id: 2, nama: "Zainal Arifin", nis: "1002", asrama: "An-Nahl", status: "Aktif", poin: 0 }
            ],
            izin: [],
            pelanggaran: [],
            users: [{ user: 'admin', pass: '123', role: 'admin' }],
            settings: { pondok: "Pesantren Madani" }
        };

        let currentUser = null;
        let activeIzinType = '';
        let html5QrCode = null;

        function saveDB() { localStorage.setItem('esantri_pro_v4', JSON.stringify(db)); }
        function loadDB() {
            const saved = localStorage.getItem('esantri_pro_v4');
            if(saved) db = JSON.parse(saved);
        }

        // Logic Auth
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const user = db.users.find(x => x.user === u && x.pass === p);
            if(user) {
                currentUser = user;
                sessionStorage.setItem('esantri_session', JSON.stringify(user));
                document.getElementById('login-page').classList.add('hidden');
                initApp();
            } else { showToast("Gagal Login"); }
        };

        function initApp() {
            loadDB();
            document.getElementById('user-display').innerText = currentUser.user.toUpperCase();
            document.getElementById('admin-nav').style.display = currentUser.role === 'admin' ? 'block' : 'none';
            document.getElementById('pondok-display').innerText = db.settings.pondok;
            renderSantri();
            renderIzinLog();
            renderPelanggaran();
            renderUsers();
            initChart();
            updateDashboard();
            populateSelects();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
            document.querySelector(`[data-tab="${t}"]`).classList.add('nav-active');
            document.getElementById('page-title').innerText = t.toUpperCase();
        }

        // SMART MODAL LOGIC
        function openIzinModal(type) {
            activeIzinType = type;
            const modal = document.getElementById('modal-smart-izin');
            const header = document.getElementById('smart-header');
            const submit = document.getElementById('sm-submit');
            
            // Reset Views
            document.getElementById('area-biasa').classList.add('hidden');
            document.getElementById('area-libur').classList.add('hidden');
            document.getElementById('area-checkin').classList.add('hidden');
            document.getElementById('sm-info').classList.add('hidden');
            document.getElementById('sm-nis').value = '';
            
            if(type === 'biasa') {
                document.getElementById('smart-title').innerText = "IZIN BIASA";
                header.className = "px-6 py-4 flex justify-between items-center text-white bg-orange-500";
                document.getElementById('area-biasa').classList.remove('hidden');
                submit.innerText = "PROSES IZIN";
                submit.className = "w-full py-4 bg-orange-500 text-white font-black rounded-2xl shadow-lg";
            } else if(type === 'libur') {
                document.getElementById('smart-title').innerText = "LIBUR PANJANG";
                header.className = "px-6 py-4 flex justify-between items-center text-white bg-blue-500";
                document.getElementById('area-libur').classList.remove('hidden');
                submit.innerText = "PROSES LIBUR";
                submit.className = "w-full py-4 bg-blue-500 text-white font-black rounded-2xl shadow-lg";
            } else {
                document.getElementById('smart-title').innerText = "CHECK-IN SANTRI";
                header.className = "px-6 py-4 flex justify-between items-center text-white bg-emerald-500";
                document.getElementById('area-checkin').classList.remove('hidden');
                submit.innerText = "KONFIRMASI CHECK-IN";
                submit.className = "w-full py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg";
            }

            modal.classList.remove('hidden');
        }

        function closeSmartModal() {
            stopScanner();
            document.getElementById('modal-smart-izin').classList.add('hidden');
        }

        // Scanner Logic
        async function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if(container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader-global");
                await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                    document.getElementById('sm-nis').value = txt;
                    lookupSantri(txt);
                    stopScanner();
                });
            } else {
                stopScanner();
            }
        }

        function stopScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                    html5QrCode = null;
                });
            }
        }

        document.getElementById('sm-nis').oninput = (e) => lookupSantri(e.target.value);

        function lookupSantri(nis) {
            const santri = db.santri.find(s => s.nis === nis);
            const info = document.getElementById('sm-info');
            if(santri) {
                info.innerText = `Santri: ${santri.nama} | Kamar: ${santri.asrama} | Status: ${santri.status}`;
                info.className = "p-3 bg-emerald-50 rounded-xl text-xs font-semibold text-emerald-700 block";
            } else {
                info.innerText = "NIS tidak ditemukan";
                info.className = "p-3 bg-red-50 rounded-xl text-xs font-semibold text-red-700 block";
            }
        }

        function processSmartAction() {
            const nis = document.getElementById('sm-nis').value;
            const santri = db.santri.find(s => s.nis === nis);

            if(!santri) return showToast("Pilih Santri Terlebih Dahulu");

            const record = {
                id: Date.now(),
                sid: santri.id,
                nama: santri.nama,
                tgl: new Date().toLocaleDateString('id-ID'),
                status: activeIzinType === 'checkin' ? 'Kembali' : 'Pulang'
            };

            if(activeIzinType === 'biasa') {
                santri.status = "Izin";
                record.tipe = "Izin Biasa";
                record.detail = `Keluar: ${document.getElementById('sm-tgl-out').value} | Kembali: ${document.getElementById('sm-tgl-in').value}`;
            } else if(activeIzinType === 'libur') {
                santri.status = "Libur";
                record.tipe = "Libur Panjang";
                record.detail = `Mulai: ${document.getElementById('lib-start').value} | End: ${document.getElementById('lib-end').value}`;
            } else {
                santri.status = "Aktif";
                record.tipe = "Check-In";
                record.detail = "Santri kembali ke pondok";
            }

            db.izin.push(record);
            saveDB();
            initApp();
            closeSmartModal();
            showToast("Berhasil diproses!");
        }

        // Render Utilities (Santri, Pelanggaran, Dashboard)
        function renderSantri() {
            const q = document.getElementById('src-santri').value.toLowerCase();
            const body = document.getElementById('table-santri');
            body.innerHTML = '';
            db.santri.filter(s => s.nama.toLowerCase().includes(q) || s.nis.includes(q)).forEach(s => {
                body.innerHTML += `<tr>
                    <td class="p-4 font-bold">${s.nama}</td>
                    <td class="p-4 text-slate-500 font-mono text-xs">${s.nis}</td>
                    <td class="p-4 text-xs font-semibold">${s.asrama}</td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${s.status==='Aktif'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${s.status}</span></td>
                    <td class="p-4 text-right">
                        ${currentUser.role==='admin'?`<button onclick="delSantri(${s.id})" class="text-red-400"><i class="fas fa-trash"></i></button>`:'-'}
                    </td>
                </tr>`;
            });
        }

        function renderIzinLog() {
            const log = document.getElementById('log-izin');
            log.innerHTML = '';
            [...db.izin].reverse().forEach(i => {
                log.innerHTML += `<div class="p-4 flex justify-between items-center text-sm">
                    <div><p class="font-bold">${i.nama} <span class="text-[10px] uppercase text-slate-400 ml-2">${i.tipe}</span></p><p class="text-[10px] text-slate-400">${i.detail}</p></div>
                    <div class="text-[10px] font-bold ${i.status==='Kembali'?'text-emerald-500':'text-orange-500'}">${i.status.toUpperCase()}</div>
                </div>`;
            });
        }

        function renderPelanggaran() {
            const body = document.getElementById('table-pelanggaran'); body.innerHTML = '';
            db.pelanggaran.forEach(p => {
                body.innerHTML += `<tr><td class="p-3 font-bold">${p.nama}</td><td class="p-3">${p.tipe}</td><td class="p-3 font-black text-red-600">${p.poin}</td><td class="p-3 text-[10px]">${p.tgl}</td></tr>`;
            });
        }

        function renderUsers() {
            const list = document.getElementById('list-user'); list.innerHTML = '';
            db.users.forEach(u => {
                list.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-xs font-bold">
                    <span>${u.user} (${u.role})</span>
                    ${u.user!=='admin'?`<button onclick="delUser('${u.user}')" class="text-red-500">&times;</button>`:''}
                </div>`;
            });
        }

        function populateSelects() {
            document.getElementById('p-sid').innerHTML = '<option value="">Pilih Santri...</option>' + db.santri.map(s => `<option value="${s.id}">${s.nama} (${s.nis})</option>`).join('');
        }

        function updateDashboard() {
            document.getElementById('dash-total').innerText = db.santri.length;
            document.getElementById('dash-izin').innerText = db.santri.filter(s => s.status !== 'Aktif').length;
            document.getElementById('dash-poin').innerText = db.santri.reduce((a,b) => a + b.poin, 0);
            document.getElementById('dash-user').innerText = db.users.length;
        }

        function showToast(m) {
            const t = document.getElementById('toast'); t.innerText = m;
            t.classList.remove('opacity-0', 'translate-y-2'); t.classList.add('opacity-100', '-translate-y-2');
            setTimeout(() => { t.classList.remove('opacity-100', '-translate-y-2'); t.classList.add('opacity-0', 'translate-y-2'); }, 2000);
        }

        // Form Submits
        document.getElementById('form-santri').onsubmit = (e) => {
            e.preventDefault();
            db.santri.push({ id: Date.now(), nama: document.getElementById('s-nama').value, nis: document.getElementById('s-nis').value, asrama: document.getElementById('s-asrama').value, status: 'Aktif', poin: 0 });
            saveDB(); initApp(); document.getElementById('modal-santri').classList.add('hidden'); e.target.reset();
        };

        document.getElementById('form-pelanggaran').onsubmit = (e) => {
            e.preventDefault();
            const sid = parseInt(document.getElementById('p-sid').value);
            const santri = db.santri.find(s => s.id === sid);
            const pMap = { "Ringan": 5, "Sedang": 25, "Berat": 100 };
            const p = { sid, nama: santri.nama, tipe: document.getElementById('p-tipe').value, poin: pMap[document.getElementById('p-tipe').value], ket: document.getElementById('p-ket').value, tgl: new Date().toLocaleDateString('id-ID') };
            db.pelanggaran.push(p); santri.poin += p.poin;
            saveDB(); initApp(); e.target.reset();
        };

        document.getElementById('form-user').onsubmit = (e) => {
            e.preventDefault();
            db.users.push({ user: document.getElementById('u-name').value, pass: document.getElementById('u-pass').value, role: 'pengurus' });
            saveDB(); initApp(); e.target.reset();
        };

        function delUser(u) { db.users = db.users.filter(x => x.user !== u); saveDB(); initApp(); }
        function delSantri(id) { if(confirm("Hapus?")) { db.santri = db.santri.filter(s => s.id !== id); saveDB(); initApp(); } }
        function saveSettings() { db.settings.pondok = document.getElementById('set-pondok').value; saveDB(); initApp(); showToast("Tersimpan!"); }
        function logout() { sessionStorage.removeItem('esantri_session'); location.reload(); }

        let chart = null;
        function initChart() {
            const ctx = document.getElementById('kamarChart').getContext('2d');
            const kamars = {}; db.santri.forEach(s => kamars[s.asrama] = (kamars[s.asrama] || 0) + s.poin);
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(kamars), datasets: [{ label: 'Akumulasi Poin Per Kamar', data: Object.values(kamars), backgroundColor: '#ef4444', borderRadius: 10 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function exportData(type) {
            let csv = type === 'izin' ? 'Nama,Tipe,Detail,Status,Tanggal\n' : 'Nama,Tipe,Poin,Tanggal\n';
            const data = type === 'izin' ? db.izin : db.pelanggaran;
            data.forEach(d => {
                csv += type === 'izin' ? `${d.nama},${d.tipe},${d.detail},${d.status},${d.tgl}\n` : `${d.nama},${d.tipe},${d.poin},${d.tgl}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `rekap_${type}.csv`; a.click();
        }

        window.onload = () => {
            const session = sessionStorage.getItem('esantri_session');
            if(session) {
                currentUser = JSON.parse(session);
                document.getElementById('login-page').classList.add('hidden');
                initApp();
            }
        };

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    </script>
</body>
</html>
